# План доработки игры «Золотой Запас» (Match-3)

## Общая концепция
Превратить демо-заглушку в полноценную match-3 игру с интеграцией бустера «Газпромбанк Бонус» согласно концепции из game-tz/3-v-ryad.md.

## Цель MVP
Создать 20-30 секундный демо-сценарий, демонстрирующий:
- Работающую механику match-3
- Систему зарядки бустера через комбинации
- Применение бустера «Бонус-Ракета» с взрывом 3x3
- Достижение цели по очкам
- Связь с продуктом «Газпромбанк Бонус»

---

## Итерация 1: Базовая архитектура и состояние игры ✅
**Объем работ:** ~10%
**Цели:**
- Создать TypeScript интерфейсы для игрового состояния
- Реализовать основные типы (Cell, GameState, Position)
- Настроить Svelte stores для управления состоянием
- Создать базовую структуру классов/функций

**Задачи:**
- Определить типы фишек: `coin`, `sapphire`, `emerald`, `gold`
- Создать интерфейс `GameState` с полями score, moves, boosterCharge
- Реализовать `gameField` как реактивный store
- Создать enum для статусов игры: `playing`, `targeting`, `completed`
- Базовая валидация состояния

**Результат выполнения:**
- Созданы типы и интерфейсы в `types.ts`: CellType, GameStatus, Position, Cell, Match3GameState, BoosterState
- Настроены константы игры в `constants.ts`: размеры поля, очки, зарядка бустера
- Реализован реактивный store в `gameState.ts` с интеграцией в основной gameStore
- Создана базовая логика в `gameLogic.ts`: валидация, инициализация поля, работа с позициями
- Переименован Match3Demo.svelte в Match3Game.svelte с интеграцией новой архитектуры
- Обновлены все ссылки в gameLoader.ts, games.ts, vite.config.ts
- Проект успешно собирается

---

## Итерация 2: Динамическое игровое поле ✅
**Объем работ:** ~10%
**Цели:**
- Заменить статический массив на динамическую генерацию
- Реализовать алгоритм заполнения поля без начальных комбинаций
- Создать функции перемешивания и проверки возможных ходов

**Задачи:**
- Функция `generateField()` для создания случайного поля 8x8
- Алгоритм `checkInitialMatches()` для предотвращения стартовых комбинаций
- Функция `shuffleField()` для перемешивания
- Функция `hasPossibleMoves()` для проверки доступных ходов
- Обновить отрисовку поля под новую структуру данных

**Результат выполнения:**
- Реализованы функции поиска комбинаций: `findMatches()`, `findHorizontalMatch()`, `findVerticalMatch()`, `hasMatchAt()`
- Создан алгоритм `checkInitialMatches()` для проверки отсутствия начальных комбинаций в поле
- Усовершенствована функция `generateField()` с проверкой комбинаций и fallback на `forceGenerateValidField()`
- Добавлена функция `getAvailableTypesForPosition()` для умной генерации поля без начальных совпадений
- Реализована функция `shuffleField()` для перемешивания существующего поля
- Создана функция `hasPossibleMoves()` для проверки доступности ходов путем симуляции свапов
- Обновлена `initializeGameField()` для использования нового алгоритма генерации
- Проект успешно собирается, все TypeScript типы корректны

---

## Итерация 3: Механика выбора и свапа фишек ✅
**Объем работы:** ~10%
**Цели:**
- Реализовать выбор фишек кликом
- Добавить логику свапа соседних фишек
- Создать валидацию корректности ходов

**Задачи:**
- Состояние `selectedCell` для отслеживания выбранной фишки
- Функция `selectCell(row, col)` с подсветкой выбранной клетки
- Функция `swapCells(from, to)` для обмена фишек
- Валидация `isValidSwap()` - только соседние клетки
- Анимация свапа с `transition` (базовая)
- Откат неудачного свапа

**Результат выполнения:**
- Реализованы функции валидации свапа в `gameLogic.ts`: `isValidSwap()`, `isSwapResultingInMatch()`, `performSwap()`
- Добавлены методы обработки свапа в `gameState.ts`: `attemptSwap()`, `highlightSelectedCell()`, `clearSelection()`
- Завершена логика `handleCellClick()` в Match3Game.svelte с полным циклом выбора и свапа клеток
- Реализованы CSS анимации: hover эффект, пульсация выбранной клетки, анимация свапа и тряска для неудачных попыток
- Расширены типы в `types.ts`: добавлены поля анимации в Cell, интерфейсы SwapResult и AnimationState
- Обновлены константы анимаций в `constants.ts` и добавлена секция UI_CONFIG
- Обновлена подсказка в игре на "Итерация 3" с описанием новой механики
- Проект успешно собирается через `npm run build`

---

## Итерация 4: Детекция и обработка комбинаций ✅
**Объем работ:** ~10%
**Цели:**
- Алгоритм поиска комбинаций 3+ в ряд
- Удаление найденных комбинаций
- Подсчет типов комбинаций (3, 4, 5+ элементов)

**Задачи:**
- Функция `findMatches()` для поиска горизонтальных/вертикальных линий
- Функция `removeMatches()` с пометкой клеток для удаления
- Функция `classifyMatches()` для определения размера комбинаций
- Каскадная проверка после удаления
- Базовое падение фишек после удаления

**Результат выполнения:**
- Реализованы функции обработки комбинаций в `gameLogic.ts`: `removeMatches()`, `classifyMatches()`, `dropCells()`, `processMatches()`, `cascadeMatches()`
- Интегрирована система очков: 3 в ряд = 100 очков, 4 в ряд = 300 очков, 5+ в ряд = 500 очков
- Добавлена зарядка бустера от больших комбинаций: 4 в ряд = +30 заряда, 5+ в ряд = +50 заряда
- Реализована каскадная логика: после удаления комбинаций фишки падают вниз, пустые места заполняются новыми фишками, процесс повторяется до отсутствия новых комбинаций
- Обновлена функция `attemptSwap()` в `gameState.ts` для полной интеграции обработки комбинаций в игровой цикл
- Добавлены проверки условий победы/поражения при каждом ходе
- Обновлена подсказка в UI на "Итерация 4" с описанием новой функциональности
- Проект успешно собирается через `npm run build`

---

## Итерация 5: Система очков и ходов ✅
**Объем работ:** ~10%
**Цели:**
- Подсчет очков за разные типы комбинаций
- Учет ходов и условий победы/поражения
- Интеграция с UI счетчиков

**Задачи:**
- Формула начисления очков: 3 в ряд = 100, 4 в ряд = 300, 5+ в ряд = 500
- Функция `updateScore(matchType, count)`
- Счетчик ходов с уменьшением после каждого valid move
- Условие победы: достижение целевого количества очков (5000)
- Условие поражения: ходы закончились
- Анимация изменения счета

**Результат выполнения:**
- Создан компонент `GameOverModal.svelte` с полным экраном результатов игры: отображение очков, прогресса к цели, статистики ходов и звездного рейтинга
- Добавлен компонент `ScoreBoost.svelte` для анимированного показа больших начислений очков (200+) с иконками и эффектами
- Интегрирована система показа результатов: модальное окно появляется при завершении игры с кнопками перезапуска и выхода
- Улучшена анимация счетчика очков: при больших начислениях появляются анимированные всплывающие подсказки с рейтингами (NICE!, GREAT!, AMAZING!)
- Расширено состояние игры полем `scoreBoost` для отслеживания анимаций больших начислений
- Добавлены методы `showScoreBoost()` и `hideScoreBoost()` в gameState для управления анимациями
- Обновлена подсказка в UI до "Итерация 5" с описанием новой функциональности
- Исправлена совместимость с Svelte 5 runes mode (замена `$:` на `$derived`)
- Проект успешно собирается через `npm run build`

---

## Итерация 6: Система бустера и зарядка ✅
**Объем работ:** ~10%
**Цели:**
- Шкала зарядки бустера «Газпромбанк Бонус»
- Логика зарядки от больших комбинаций
- UI элементы бустера

**Задачи:**
- Шкала `boosterCharge` от 0 до 100
- Зарядка: 4 в ряд = +30, 5+ в ряд = +50, L/T формы = +40
- UI компонент шкалы с градиентом брендовых цветов
- Кнопка бустера с логотипом "Газпромбанк Бонус"
- Состояние кнопки: неактивная/активная/сияющая
- Функция `chargeBooster(matchType)`

**Результат выполнения:**
- Создана функция `chargeBooster(matchType)` в `gameLogic.ts` для стандартизированной зарядки бустера
- Добавлен новый тип `MatchType` в `types.ts` для классификации типов комбинаций
- Реализована функция `determineMatchType()` для автоматического определения типа комбинации по длине
- Добавлен обработчик `handleBoosterClick()` в `Match3Game.svelte` для активации бустера
- Обновлена кнопка бустера с логотипом "Газпромбанк Бонус" и динамическими состояниями
- Интегрирован режим нацеливания: при активации бустера кнопка показывает "Выберите цель!"
- Улучшена визуальная обратная связь: кнопка имеет состояния неактивная/готова к применению
- Обновлена подсказка в UI с описанием новой функциональности итерации 6
- Проект успешно собирается через `npm run build`

---

## Итерация 7: Применение бустера «Бонус-Ракета» ✅
**Объем работ:** ~10%
**Цели:**
- Режим нацеливания бустера
- Взрыв области 3x3 вокруг выбранной точки
- Обработка результата взрыва

**Задачи:**
- Режим `targeting` при активации бустера
- Визуальное изменение курсора/интерфейса в режиме нацеливания
- Функция `applyBooster(targetRow, targetCol)` для взрыва 3x3
- Расчет области взрыва с учетом границ поля
- Удаление всех фишек в области взрыва
- Большое начисление очков за применение бустера (1000+ очков)
- Сброс заряда бустера до 0

**Результат выполнения:**
- Добавлены функции `getExplosionPositions()` и `applyBooster()` в `gameLogic.ts` для расчета и применения взрыва области 3x3
- Интегрирован метод `applyBooster()` в `gameState.ts` с полным циклом: взрыв → каскадные комбинации → начисление 1000 очков → сброс заряда
- Обновлена логика `handleCellClick()` в Match3Game.svelte для обработки режима targeting с приоритетом над обычными действиями
- Добавлены визуальные эффекты: курсор crosshair в режиме targeting, hover эффект с золотой подсветкой, CSS анимация взрыва
- Реализован полный цикл применения бустера: активация кнопки → режим targeting → клик по цели → взрыв 3x3 → каскад → возврат к игре
- Обновлена подсказка в UI на описание итерации 7 с инструкциями по использованию бустера
- Проект успешно собирается через `npm run build`

---

## Итерация 8: Анимации и визуальные эффекты ✅
**Объем работ:** ~10%
**Цели:**
- Плавные анимации для всех игровых действий
- Эффектный взрыв бустера
- Полировка визуального опыта

**Задачи:**
- Анимация падения фишек после удаления комбинаций
- Плавное заполнение шкалы бустера
- Эффект сияния активированной кнопки бустера
- **Ключевая анимация**: взрыв 3x3 с particles, вспышкой, sound effect
- Анимация cascade падения новых фишек сверху
- Transition для смены счета очков
- Micro-анимации hover/active состояний

**Результат выполнения:**
- Расширены константы анимаций в `constants.ts`: добавлены таймеры для новых эффектов (CELL_BOUNCE, EXPLOSION_PARTICLE, BOOSTER_GLOW и др.)
- Создан компонент `ParticleEffect.svelte` с реалистичной физикой частиц и радиальной вспышкой для взрывов
- Улучшены анимации падения клеток: добавлены CSS классы falling, bouncing, fading, appearing с эффектами каскадного появления
- Реализовано плавное заполнение шкалы бустера с волновыми эффектами (charge-wave, shimmer)
- Добавлено продвинутое сияние кнопки бустера: pulse-glow, rotating border, shimmer-sweep эффекты
- Усовершенствованы micro-анимации: улучшены hover/active состояния с cubic-bezier easing и backdrop-filter
- Интегрирована анимированная смена счета через существующий Counter компонент с score-flash эффектом
- Добавлена поддержка prefers-reduced-motion для доступности
- Обновлена подсказка в UI на описание итерации 8 с новой функциональностью
- Проект успешно собирается через `npm run build`

---

## Итерация 9: Демо-сценарий и обучение ✅
**Объем работ:** ~10%
**Цели:**
- Создать управляемый демо-сценарий согласно концепции
- Добавить подсказки и обучающие элементы
- Интегрировать финальный экран с продуктом

**Задачи:**
- Предзаготовленное поле с гарантированными комбинациями 4+ элементов
- Подсветка рекомендуемых ходов для зарядки бустера
- Текстовые подсказки: "Бонус готов! Выберите цель!"
- Сценарий: 2 хода → зарядка → применение → победа
- Экран победы с текстом о программе "Газпромбанк Бонус"
- Кнопка "Узнать больше о программе" (неактивная)

**Результат выполнения:**
- Создана функция `generateDemoField()` с предзаготовленным полем для управляемого демо-сценария
- Добавлен демо-режим в типы игры с интерфейсами `DemoState` и расширенным `Match3GameState`
- Реализован компонент `DemoHint.svelte` с модальными подсказками и индикатором прогресса (3 шага)
- Интегрирована система подсветки рекомендуемых ходов с золотыми анимациями и пульсирующими эффектами
- Создан управляемый сценарий в `gameState.ts`: автоматический переход между шагами при успешных ходах
- Обновлен `GameOverModal.svelte` со специальным образовательным контентом для демо-режима
- Добавлена карточка программы "Газпромбанк Бонус" с описанием преимуществ и неактивной кнопкой
- Интегрирован полный демо-режим в `Match3Game.svelte` с автозапуском при открытии игры
- Обновлена подсказка в UI на "Итерация 9" с описанием новой функциональности
- Проект успешно собирается через `npm run build` без критических ошибок

---

## Итерация 10: Финальная полировка и интеграция
**Объем работ:** ~10%
**Цели:**
- Оптимизация производительности
- Финальное тестирование и отладка
- Интеграция с игровой экосистемой

**Задачи:**
- Оптимизация алгоритмов поиска комбинаций
- Тестирование на разных разрешениях экрана
- Проверка доступности (keyboard navigation, screen readers)
- Интеграция с общей системой очков/статистики
- Фикс багов и edge cases
- Финальная настройка баланса (таймингов, количества очков)
- Подготовка к интеграции в основное приложение

---

## Технические детали

### Структура файлов:
```
src/games/match3-golden-reserve/
├── Match3Game.svelte          # Основной компонент (переименовать из Match3Demo)
├── gameLogic.ts              # Логика игры и алгоритмы
├── gameState.ts              # Svelte stores для состояния
├── types.ts                  # TypeScript интерфейсы
├── animations.ts             # Утилиты для анимаций
└── constants.ts              # Константы игры
```

### Ключевые константы:
- Размер поля: 8x8
- Целевой счет: 5000 очков
- Количество ходов: 5 (для демо)
- Типы фишек: coin, sapphire, emerald, gold
- Зарядка бустера: 4 в ряд = 30%, 5+ в ряд = 50%

### Интеграция продукта:
- Логотип "Газпромбанк Бонус" на кнопке бустера
- Фирменные цвета в UI элементах
- Образовательный текст в финальном экране
- Связь механики игры с реальной пользой программы лояльности