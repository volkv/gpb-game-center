# План интеграции игры FinCity в Игровой Центр Газпромбанка (Stateless версия)

## Обзор задачи

Интеграция standalone игры FinCity (Svelte 5 + PixiJS) в существующий игровой центр (SvelteKit), с правильной настройкой lazy loading для PixiJS и переносом интеграции Telegram в глобальную систему. **Игра будет stateless** - без сохранения прогресса и автосейва.

## Итерация 1: Подготовка инфраструктуры и роутинга (25%)

### Задачи:
- ✅ Создать роут `/games/fincity` в SvelteKit приложении
- Обновить `gameLoader.ts` для поддержки динамической загрузки FinCity
- Создать обертку-компонент `FincityGame.svelte` в `/src/games/fincity/`
- Настроить Vite конфигурацию для правильного chunk splitting PixiJS
- Удалить всю логику сохранения из исходного кода игры

### Результат:
- Рабочий роут для игры с базовой загрузкой
- PixiJS загружается только при переходе в игру
- Игра появляется в списке игр на главной странице
- Убрана система сохранений и автосейва

### ✅ ВЫПОЛНЕНО:
- Добавлен тип `FINCITY` в константы игр (`constants.ts`)
- Создана запись FinCity в каталоге игр (`games.ts`) с полными метаданными
- Создан SvelteKit роут `/games/fincity/+page.svelte` для прямых ссылок
- Реализован компонент-обертка `FincityGame.svelte` с lazy loading
- Обновлен `gameLoader.ts` для поддержки динамической загрузки FinCity
- Настроена Vite конфигурация с правильным chunk splitting
- Установлена зависимость PixiJS в основной проект
- Исправлены конфигурации TypeScript для совместимости
- Успешно протестирована сборка проекта `npm run build`

## Итерация 2: Перенос игровых компонентов без системы сохранений (25%)

### ✅ ВЫПОЛНЕНО:
- Создана новая структура папок для FinCity компонентов:
  - `src/games/fincity/components/game/` - игровой движок
  - `src/games/fincity/components/ui/` - UI компоненты
  - `src/games/fincity/stores/` - stores
  - `src/games/fincity/types/` - типы
  - `src/games/fincity/assets/` - ассеты
- Перенесены все файлы игрового движка (GameEngine, SceneManager, BuildingSystem и др.)
- Перенесены все Svelte UI компоненты (TopBar, GameCanvas, BuildMenu и др.)
- Перенесены все типы и интерфейсы
- Перенесены ассеты (иконки, изображения зданий, текстуры)
- Полностью удалены системы сохранений:
  - Удалены ссылки на `storage.ts` и `autoSave.ts`
  - Убраны все использования localStorage
  - Функция `checkIfFirstTime()` теперь всегда возвращает true
- Модифицированы stores для stateless работы:
  - Убраны функции сохранения/загрузки состояния
  - Добавлены функции сброса к начальным значениям
  - Игра начинается с чистого состояния при каждом запуске
- Обновлен `FincityGame.svelte` для загрузки новой структуры
- Создан новый `App.svelte` с системой сброса всех stores при запуске
- Обновлены все index.ts файлы для правильного экспорта
- Основная функциональность интегрирована, остается решить проблемы с Tailwind CSS конфигурацией

---

## Итерация 2: Перенос игровых компонентов без системы сохранений (25%)

### Задачи:
- Перенести игровой движок (`GameEngine.ts`, `SceneManager.ts`, `BuildingSystem.ts` и др.)
- Адаптировать основные Svelte компоненты игры без persistence логики
- Настроить корректную загрузку ассетов и текстур
- Убрать все ссылки на `storage.ts`, `autoSave.ts` и localStorage
- Модифицировать stores для работы только в памяти (без persist)
- Интегрировать систему состояний игры с navigation store игрового центра

### Результат:
- Основная игра работает внутри игрового центра
- Корректное отображение и управление
- Работающая система построек и ресурсов в памяти
- Каждый запуск игры начинается с чистого состояния

---


## Итерация 3: Решить проблемы с Tailwind CSS конфигурацией

### Задачи:
- Разобраться с отдельной конфигурацией игры fincity, чтобы у игры сотался свой стиль и при этом остальные глобальные конфиги не были изменены


---
## Итерация 4: Глобальная интеграция Telegram и статус бар (25%)

### Задачи:
- Создать глобальный верхний статус бар для всего игрового центра
- Перенести `telegramIntegration.ts` в `/src/lib/telegram/`
- Создать глобальный store для пользователя Telegram (`/src/lib/stores/telegramStore.ts`)
- Отображать имя пользователя в статус баре
- Создать глобальный счетчик игровых сессий/активности
- Обновить layout приложения для включения статус бара

### Результат:
- Глобальный статус бар с информацией о пользователе Telegram
- Унифицированная система пользователя для всех игр
- Отображение общей активности пользователя

### ✅ ВЫПОЛНЕНО:
- Создан глобальный telegramStore с полным функционалом:
  - Управление состоянием пользователя Telegram
  - Автоматический счетчик сессий (по дням)
  - Счетчик запуска игр с автосохранением в localStorage
  - Derived stores для удобного доступа к данным
- Создан StatusBar компонент с адаптивным дизайном:
  - Отображение аватара пользователя (Telegram/обычный)
  - Показ имени пользователя и платформы
  - Статистика активности (сессии и игры)
  - Градиентный фон в стиле бренда ГПБ
- StatusBar интегрирован в глобальный layout приложения
- Создана telegram интеграция в `/src/lib/telegram/integration.ts`:
  - Проверка Telegram окружения
  - Получение данных пользователя
  - Инициализация WebApp с полноэкранным режимом
  - Unified типизация через `/src/lib/types/Telegram.ts`
- Игра FinCity интегрирована с глобальным счетчиком:
  - Автоматический вызов telegramStore.incrementGameCount() при запуске
  - Удалена дублирующая старая телеграм интеграция
- Проект успешно собирается без ошибок компиляции


---

## Итерация 5: Финальная интеграция и оптимизация (25%)

### ✅ ВЫПОЛНЕНО:

**Техническая очистка и оптимизация проекта:**
- Удален legacy eslint.config.js из папки fincity
- Очищены build директории от старых артефактов
- Исправлены Vite warnings в конфигурации (убраны конфликтующие настройки SvelteKit)
- Исправлена проблема с manualChunks для PixiJS

**Оптимизированная система загрузки ресурсов:**
- Полностью переработан ResourceManager с приоритетной загрузкой:
  - Критические ресурсы загружаются первыми (0-40%)
  - Основные ресурсы следом (40-80%)
  - Дополнительные ресурсы в фоне (80-100%)
- Добавлена intelligent кэширование в localStorage с версионированием
- Реализован batch-loading по 5 ассетов для оптимальной производительности
- Добавлен мониторинг использования памяти и автоматическая очистка

**Продвинутый прелоадер с детальными индикаторами:**
- Обновлен LoadingScreen.svelte для отображения детальной информации:
  - Показ текущего этапа загрузки
  - Счетчик загруженных ресурсов (X / Y ресурсов)
  - Индикатор потребления памяти (~X МБ)
  - Анимированный прогресс-бар с плавными переходами
- Добавлены этапы загрузки с описательными названиями

**Memory leak protection и управление ресурсами:**
- Реализована автоматическая очистка PixiJS ресурсов в FincityGame.svelte:
  - onDestroy хук для корректного завершения
  - beforeunload обработчик для очистки при закрытии страницы
  - Автоматический вызов ResourceManager.unloadAll()
  - Принудительный вызов garbage collector (если доступен)
- Добавлены методы оптимизации памяти в ResourceManager:
  - optimizeMemoryUsage() для удаления неиспользуемых текстур
  - getMemoryUsage() для мониторинга потребления памяти
  - Автоматическая очистка устаревших кэшированных ресурсов

**Production-ready сборка:**
- Успешная сборка проекта npm run build без критических ошибок
- Исправлены конфликты в Vite конфигурации
- Оптимизированные чанки для лучшей загрузки
- Проект готов для развертывания в production окружении

### Результат:
- ✅ Полностью оптимизированная stateless игра FinCity в игровом центре
- ✅ Производительная система загрузки с приоритизацией и кэшированием
- ✅ Продвинутый прелоадер с детальной информацией о прогрессе
- ✅ Защита от утечек памяти и автоматическая очистка ресурсов
- ✅ Production-ready сборка с правильным chunk splitting
- ✅ Готовое решение для развертывания в Telegram WebApp

---

## Технические детали

### Структура файлов после интеграции:
```
src/
├── lib/
│   ├── stores/
│   │   └── telegramStore.ts      # Глобальный Telegram store
│   ├── telegram/
│   │   └── integration.ts        # Telegram WebApp интеграция
│   └── components/
│       └── StatusBar.svelte      # Глобальный статус бар
├── games/
│   └── fincity/
│       ├── FincityGame.svelte    # Обертка-компонент игры
│       ├── components/           # Компоненты игры (без сохранений)
│       ├── game/                 # Игровой движок (PixiJS)
│       └── stores/               # Локальные stores (только в памяти)
└── routes/
    └── games/
        └── fincity/
            └── +page.svelte      # Роут страницы игры
```

### Ключевые технические решения:
- Dynamic imports для PixiJS: `import('./game/GameEngine.js')` при активации игры
- Chunk splitting в Vite для разделения PixiJS и основного кода
- Унифицированная система навигации через navigation store
- Глобальный store только для пользователя Telegram
- Stateless игровая логика - каждый запуск с нуля
- Удаление всех модулей: `storage.ts`, `autoSave.ts`, persistence логики

### Критерии готовности:
1. Игра FinCity корректно работает в игровом центре
2. PixiJS загружается только при открытии игры
3. Telegram интеграция работает глобально для всех игр
4. Статус бар отображает информацию о пользователе
5. **Игра полностью stateless - нет сохранений и восстановления состояния**
6. Навигация между играми работает корректно
7. Память очищается при выходе из игры